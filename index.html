<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Math Mario: Final Mobile</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #222;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            touch-action: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í„°ì¹˜ ë™ì‘ ë°©ì§€ */
        }
        canvas {
            border: 4px solid #000;
            background-color: #5c94fc; /* ê¸°ë³¸ í•˜ëŠ˜ìƒ‰ (ì´ë¯¸ì§€ ì—†ì„ ë•Œ) */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            max-width: 100%; /* í™”ë©´ ë„ˆë¹„ì— ë§ì¶¤ */
            height: auto;
            image-rendering: pixelated; /* í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼ ê°•ì¡° */
        }
        .ui-layer {
            position: absolute;
            top: 10px;
            color: white;
            font-family: 'Malgun Gothic', sans-serif;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 10px;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            z-index: 10;
        }
        
        /* --- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ëŸ¬ ìŠ¤íƒ€ì¼ --- */
        .controls {
            display: flex;
            justify-content: space-between;
            width: 800px;
            max-width: 100%;
            margin-top: 15px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            cursor: pointer;
            touch-action: manipulation; /* í„°ì¹˜ ë°˜ì‘ì„± í–¥ìƒ */
        }
        .btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95); /* ëˆŒë¦¼ íš¨ê³¼ */
        }
        .d-pad { display: flex; gap: 15px; }
        .action-pad { display: flex; }

        /* ì‘ì€ í™”ë©´(ëª¨ë°”ì¼)ì— ë§ì¶° ë²„íŠ¼ í¬ê¸° ì¡°ì ˆ */
        @media (max-width: 600px) {
            canvas { width: 100%; height: auto; }
            .btn { width: 60px; height: 60px; font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="ui-layer">
        <h3>ìŠˆí¼ ìˆ˜í•™ ë§ˆë¦¬ì˜¤</h3>
        <p>PC: ë°©í–¥í‚¤ + Space | ëª¨ë°”ì¼: ì•„ë˜ ë²„íŠ¼ í„°ì¹˜</p>
    </div>

    <canvas id="gameCanvas" width="800" height="450"></canvas>

    <div class="controls">
        <div class="d-pad">
            <div class="btn" id="btnLeft">â†</div>
            <div class="btn" id="btnRight">â†’</div>
        </div>
        <div class="action-pad">
            <div class="btn" id="btnJump" style="border-radius: 20px; width: 100px;">Jump</div>
        </div>
    </div>

<script>
    // --- [1. ê·¸ë˜í”½ ì´ë¯¸ì§€ ì„¤ì •] ---
    // * ì´ë¯¸ì§€ íŒŒì¼ì´ HTMLê³¼ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    // * ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
    const imgPlayer = new Image(); imgPlayer.src = 'mario_transparent.png';
    const imgBlock = new Image();  imgBlock.src = 'question_block.png';
    const imgBrick = new Image();  imgBrick.src = 'brick_pattern.png';
    const imgBg = new Image();     imgBg.src = 'bg_classic.png';
    const imgMushroom = new Image(); imgMushroom.src = 'mushroom.png';

    // --- [2. íš¨ê³¼ìŒ ì‹œìŠ¤í…œ (Web Audio API)] ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume(); // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ ì˜¤ë””ì˜¤ í™œì„±í™”
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'jump') { // ì í”„ ì†Œë¦¬
            osc.type = 'square'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        } else if (type === 'coin') { // ì •ë‹µ ì†Œë¦¬
            osc.type = 'sine'; osc.frequency.setValueAtTime(987, audioCtx.currentTime); osc.frequency.setValueAtTime(1318, audioCtx.currentTime + 0.1); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
        } else if (type === 'bump') { // ì˜¤ë‹µ/ë²½ ì†Œë¦¬
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        }
        osc.start(); osc.stop(audioCtx.currentTime + isNaN(osc.stopTime) ? audioCtx.currentTime + 0.5 : osc.stopTime);
    }

    // --- [3. í€´ì¦ˆ ë°ì´í„° (5ë¬¸ì œ)] ---
    const quizData = [
        { id: 1, question: "Q1. í”¼ì 8ì¡°ê° ì¤‘ 3ì¡°ê° ì„­ì·¨. ë‚¨ì€ í”¼ìëŠ” ëª‡ %?", options: ["1. 37.5%", "2. 50%", "3. 62.5%", "4. 75%"], answerIndex: 2, explanation: "ë‚¨ì€ ê±´ 5ì¡°ê°! 5Ã·8 = 0.625 (62.5%)" },
        { id: 2, question: "Q2. 2000ì›ì˜ 15%ëŠ” ì–¼ë§ˆì¼ê¹Œìš”?", options: ["1. 150ì›", "2. 200ì›", "3. 300ì›", "4. 350ì›"], answerIndex: 2, explanation: "2000 x 0.15 = 300ì›ì…ë‹ˆë‹¤." },
        { id: 3, question: "Q3. ì‚¼ê°í˜•ì˜ ë‚´ê°ì˜ í•©ì€ ëª‡ ë„ì¼ê¹Œìš”?", options: ["1. 90ë„", "2. 180ë„", "3. 270ë„", "4. 360ë„"], answerIndex: 1, explanation: "ëª¨ë“  ì‚¼ê°í˜•ì˜ ë‚´ê°ì˜ í•©ì€ í•­ìƒ 180ë„ì…ë‹ˆë‹¤." },
        { id: 4, question: "Q4. ë‹¤ìŒ ì¤‘ ì†Œìˆ˜(Prime Number)ëŠ”?", options: ["1. 9", "2. 15", "3. 17", "4. 21"], answerIndex: 2, explanation: "17ì€ 1ê³¼ ìê¸° ìì‹ (17)ìœ¼ë¡œë§Œ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ì†Œìˆ˜ì…ë‹ˆë‹¤." },
        { id: 5, question: "Q5. 3x + 5 = 20 ì¼ ë•Œ, xì˜ ê°’ì€?", options: ["1. 3", "2. 4", "3. 5", "4. 6"], answerIndex: 2, explanation: "3x = 15, ë”°ë¼ì„œ x = 5 ì…ë‹ˆë‹¤." }
    ];

    // --- [4. ê²Œì„ ë³€ìˆ˜ ë° ìƒíƒœ] ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const STATE_RUNNING = 'RUNNING'; const STATE_QUIZ = 'QUIZ'; const STATE_EXPLAIN = 'EXPLAIN'; const STATE_CLEAR = 'CLEAR';
    let gameState = STATE_RUNNING;
    let currentQuizIndex = 0;
    const GRAVITY = 0.8; const JUMP_FORCE = -14; const MOVE_SPEED = 5; const GROUND_HEIGHT = 60;
    const player = { x: 50, y: 200, width: 40, height: 40, dy: 0, grounded: false, facingRight: true };
    let blocks = [];
    let mushroom = { visible: false, x: 0, y: 0, targetY: 0 }; 
    let feedbackMsg = ""; let feedbackTimer = 0;
    const keys = { right: false, left: false };

    // --- [5. ì…ë ¥ ì²˜ë¦¬ (í‚¤ë³´ë“œ + ëª¨ë°”ì¼ í„°ì¹˜)] ---
    // í‚¤ë³´ë“œ
    window.addEventListener('keydown', e => {
        if (e.code === 'ArrowRight') keys.right = true;
        if (e.code === 'ArrowLeft') keys.left = true;
        if (e.code === 'Space') handleJump();
    });
    window.addEventListener('keyup', e => {
        if (e.code === 'ArrowRight') keys.right = false;
        if (e.code === 'ArrowLeft') keys.left = false;
    });

    // ëª¨ë°”ì¼ í„°ì¹˜ ë²„íŠ¼ ì—°ê²°
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');
    const btnJump = document.getElementById('btnJump');

    const addTouch = (elem, code) => {
        // ë§ˆìš°ìŠ¤ í´ë¦­ ë° í„°ì¹˜ ì´ë²¤íŠ¸ ëª¨ë‘ ì²˜ë¦¬
        const startHandler = (e) => { e.preventDefault(); if(code==='jump') handleJump(); else keys[code] = true; };
        const endHandler = (e) => { e.preventDefault(); if(code!=='jump') keys[code] = false; };
        elem.addEventListener('mousedown', startHandler); elem.addEventListener('mouseup', endHandler);
        elem.addEventListener('touchstart', startHandler); elem.addEventListener('touchend', endHandler);
    };
    addTouch(btnLeft, 'left'); addTouch(btnRight, 'right'); addTouch(btnJump, 'jump');

    function handleJump() {
        if (gameState === STATE_EXPLAIN) { nextLevel(); }
        else if (player.grounded && gameState !== STATE_CLEAR) { player.dy = JUMP_FORCE; player.grounded = false; playSound('jump'); }
    }

    // --- [6. ê²Œì„ ë¡œì§ ì—…ë°ì´íŠ¸] ---
    function update() {
        if (gameState === STATE_EXPLAIN || gameState === STATE_CLEAR) return;
        
        // ì´ë™
        if (keys.right) { player.x += MOVE_SPEED; player.facingRight = true; }
        if (keys.left) { player.x -= MOVE_SPEED; player.facingRight = false; }
        // í™”ë©´ ë°–í•‘ ë§‰ê¸°
        if (player.x < 0) player.x = 0;
        if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;

        // í€´ì¦ˆ ì‹œì‘ ì²´í¬ (ìºë¦­í„°ê°€ ì¼ì • ìœ„ì¹˜ ë„ë‹¬ ì‹œ)
        if (gameState === STATE_RUNNING && player.x > 200) { startQuiz(); }

        // ë¬¼ë¦¬ (ì¤‘ë ¥ ë° ë°”ë‹¥ ì¶©ëŒ)
        player.dy += GRAVITY; player.y += player.dy;
        const floorY = canvas.height - GROUND_HEIGHT - player.height;
        if (player.y > floorY) { player.y = floorY; player.dy = 0; player.grounded = true; } else { player.grounded = false; }

        // ë¸”ë¡ ì¶©ëŒ ì²´í¬ (í€´ì¦ˆ ì¤‘ì¼ ë•Œ)
        if (gameState === STATE_QUIZ) {
            blocks.forEach(block => {
                if (player.x < block.x + block.width && player.x + player.width > block.x && player.y < block.y + block.height && player.y + player.height > block.y) {
                    if (player.dy < 0 && player.y > block.y) { // í—¤ë”© íŒì •
                        player.dy = 0; player.y = block.y + block.height; handleBlockHit(block);
                    }
                }
            });
        }
        // ë²„ì„¯ ì• ë‹ˆë©”ì´ì…˜
        if (mushroom.visible && mushroom.y > mushroom.targetY) { mushroom.y -= 2; }
        else if (mushroom.visible && gameState !== STATE_EXPLAIN) { setTimeout(() => { gameState = STATE_EXPLAIN; }, 500); }
    }

    function handleBlockHit(block) {
        if (block.hit) return;
        const quiz = quizData[currentQuizIndex];
        if ((block.id - 1) === quiz.answerIndex) { // ì •ë‹µ
            playSound('coin'); feedbackMsg = "ì •ë‹µ!!"; mushroom.x = block.x + 10; mushroom.y = block.y; mushroom.targetY = block.y - 40; mushroom.visible = true; block.hit = true;
        } else { // ì˜¤ë‹µ
            playSound('bump'); feedbackMsg = "ì˜¤ë‹µ..."; feedbackTimer = 30;
        }
    }

    function startQuiz() {
        if (currentQuizIndex >= quizData.length) { gameState = STATE_CLEAR; return; }
        gameState = STATE_QUIZ;
        const startX = 150; blocks = [];
        for(let i=0; i<4; i++) { blocks.push({ id: i+1, x: startX + (i * 120), y: 180, width: 60, height: 60, hit: false }); }
    }

    function nextLevel() {
        currentQuizIndex++;
        if (currentQuizIndex >= quizData.length) { gameState = STATE_CLEAR; return; }
        player.x = 150; gameState = STATE_RUNNING; blocks = []; mushroom.visible = false; feedbackMsg = "";
    }

    // --- [7. ê·¸ë¦¬ê¸° (ê·¸ë˜í”½ ì ìš©)] ---
    function draw() {
        // ë°°ê²½
        if (imgBg.complete && imgBg.naturalWidth) ctx.drawImage(imgBg, 0, 0, canvas.width, canvas.height);
        else { ctx.fillStyle = '#5c94fc'; ctx.fillRect(0, 0, canvas.width, canvas.height); }

        // ë°”ë‹¥
        const floorY = canvas.height - GROUND_HEIGHT;
        if (imgBrick.complete && imgBrick.naturalWidth) { const ptrn = ctx.createPattern(imgBrick, 'repeat'); ctx.fillStyle = ptrn; ctx.fillRect(0, floorY, canvas.width, GROUND_HEIGHT); }
        else { ctx.fillStyle = '#8B4513'; ctx.fillRect(0, floorY, canvas.width, GROUND_HEIGHT); }

        // í€´ì¦ˆ UI
        if (gameState === STATE_QUIZ || gameState === STATE_EXPLAIN) {
            const quiz = quizData[currentQuizIndex];
            ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(50, 20, 700, 110);
            ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 4; ctx.strokeRect(50, 20, 700, 110);
            ctx.fillStyle = 'white'; ctx.textAlign = 'center';
            ctx.font = 'bold 24px Malgun Gothic'; ctx.fillText(quiz.question, canvas.width/2, 65);
            ctx.font = '18px Malgun Gothic'; ctx.fillText(quiz.options.join("   "), canvas.width/2, 105);
        }

        // ë²„ì„¯
        if (mushroom.visible) {
            if(imgMushroom.complete && imgMushroom.naturalWidth) ctx.drawImage(imgMushroom, mushroom.x, mushroom.y, 40, 40);
            else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(mushroom.x+20, mushroom.y+20, 20, 0, Math.PI*2); ctx.fill(); }
        }

        // ë¸”ë¡
        blocks.forEach(block => {
            if (block.hit) {
                ctx.fillStyle = '#8B4513'; ctx.fillRect(block.x, block.y, block.width, block.height); ctx.strokeStyle = '#6b3e0f'; ctx.strokeRect(block.x, block.y, block.width, block.height);
            } else {
                if (imgBlock.complete && imgBlock.naturalWidth) {
                    const bounce = Math.sin(Date.now() / 200) * 2; ctx.drawImage(imgBlock, block.x, block.y + bounce, block.width, block.height);
                } else {
                    ctx.fillStyle = '#FFD700'; ctx.fillRect(block.x, block.y, block.width, block.height); ctx.strokeRect(block.x, block.y, block.width, block.height); ctx.fillStyle = 'black'; ctx.font = 'bold 30px Arial'; ctx.fillText("?", block.x+30, block.y+40);
                }
                ctx.fillStyle = 'white'; ctx.font = 'bold 20px Arial'; ctx.fillText(block.id, block.x+30, block.y+55);
            }
        });

        // í”Œë ˆì´ì–´
        if (imgPlayer.complete && imgPlayer.naturalWidth) {
            ctx.save();
            if (!player.facingRight) { ctx.scale(-1, 1); ctx.drawImage(imgPlayer, -player.x - player.width, player.y, player.width, player.height); }
            else { ctx.drawImage(imgPlayer, player.x, player.y, player.width, player.height); }
            ctx.restore();
        } else { ctx.fillStyle = 'red'; ctx.fillRect(player.x, player.y, player.width, player.height); }

        // í”¼ë“œë°± ë° í•´ì„¤
        if (feedbackMsg && feedbackTimer > 0) {
            ctx.fillStyle = feedbackMsg === "ì •ë‹µ!!" ? '#00FF00' : '#FF0000'; ctx.font = 'bold 40px Malgun Gothic'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.strokeText(feedbackMsg, player.x, player.y-20); ctx.fillText(feedbackMsg, player.x, player.y-20); feedbackTimer--;
        }
        if (gameState === STATE_EXPLAIN) {
            ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = 'white'; ctx.fillRect(100, 100, 600, 250); ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 5; ctx.strokeRect(100, 100, 600, 250);
            ctx.fillStyle = 'black'; ctx.font = 'bold 30px Malgun Gothic'; ctx.fillText("ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰", canvas.width/2, 160);
            ctx.font = '22px Malgun Gothic'; ctx.fillText(quizData[currentQuizIndex].explanation, canvas.width/2, 230);
            ctx.fillStyle = '#0066cc'; ctx.font = 'bold 20px Malgun Gothic'; ctx.fillText("[ ì í”„ ] í‚¤ë¥¼ ëˆŒëŸ¬ ë‹¤ìŒ ë‹¨ê³„ë¡œ", canvas.width/2, 300);
        }
         if (gameState === STATE_CLEAR) {
            ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.fillStyle = 'gold'; ctx.font = 'bold 50px Malgun Gothic'; ctx.fillText("ğŸ† ëª¨ë“  ë¬¸ì œ í´ë¦¬ì–´! ğŸ†", canvas.width/2, canvas.height/2);
        }
    }
    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    gameLoop();
</script>
</body>
</html>